

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Writing Benchmarks &mdash; OSS AtlasDB develop documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=7ab3649f" />
      <link rel="stylesheet" type="text/css" href="../_static/release-notes.css?v=b943762f" />
      <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=fd4cc2db" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=4191f987"></script>
      <script src="../_static/doctools.js?v=888ff710"></script>
      <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Miscellaneous" href="../miscellaneous/index.html" />
    <link rel="prev" title="Using The AtlasDB Perf Cli" href="benchmarking.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            OSS AtlasDB
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../schemas/index.html">Schemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../transactions/index.html">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster_management/index.html">Cluster Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Performance Testing</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="understanding.html">Understanding Performance Benchmarking</a></li>
<li class="toctree-l2"><a class="reference internal" href="benchmarking.html">Using The AtlasDB Perf Cli</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Writing Benchmarks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../miscellaneous/index.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes/index.html">Releases</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OSS AtlasDB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Performance Testing</a></li>
      <li class="breadcrumb-item active">Writing Benchmarks</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/palantir/atlasdb/blob/develop/docs/source/performance/writing.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="writing-benchmarks">
<span id="performance-writing"></span><h1>Writing Benchmarks<a class="headerlink" href="#writing-benchmarks" title="Permalink to this heading"></a></h1>
<p>The benchmarks are written using the <a class="reference external" href="http://openjdk.java.net/projects/code-tools/jmh/">Java Benchmarking Harness</a> (JMH) bundled with OpenJDK.  To get started understanding JMH take a look at the <a class="reference external" href="http://hg.openjdk.java.net/code-tools/jmh/file/tip/jmh-samples/src/main/java/org/openjdk/jmh/samples/">JMH Samples</a>.  Our benchmarks are found in the <code class="docutils literal notranslate"><span class="pre">atlasdb-perf</span></code> project.</p>
<p>Be sure to read <a class="reference internal" href="understanding.html#understanding"><span class="std std-ref">Understanding Performance Benchmarking</span></a> before attempting to write a benchmark.</p>
<section id="how-the-atlasdb-perf-cli-works">
<h2>How the AtlasDB-Perf CLI Works<a class="headerlink" href="#how-the-atlasdb-perf-cli-works" title="Permalink to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">AtlasDbPerfCli.java</span></code> contains the main method that the CLI runs.
It checks the provided options, sets up docker containers (if needed), and gathers the URIs of benchmarks via reflection.
Once it does all that, it kicks off JMH in the method <code class="docutils literal notranslate"><span class="pre">AtlasDbPerfCli.runJmh()</span></code>.
This method is also responsible for setting several important runtime parameters including which benchmarks to run, how many forks and threads to use, the sampling mode, and the time unit.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to run your benchmark in a debugger, you must set the number of forks to 0.
Do not forget to set set it back to 1 before you push your code!</p>
</div>
<p>JMH will then attempt to run a benchmark.
Benchmark classes are all <code class="docutils literal notranslate"><span class="pre">&#64;State</span></code> objects, which indicates that JMH can instantiate and manage them.
Each benchmark method is proceeded with a <code class="docutils literal notranslate"><span class="pre">&#64;Benchmark</span></code> annotation, marking it as a benchmark.
Each Benchmark will also have a <code class="docutils literal notranslate"><span class="pre">&#64;Warmup</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;Measurement</span></code> annotation.
The Benchmark will be run repeatedly during the warmup and measurement period.
Warmup runs are not measured and are intended to warm the relevant caches such that runs in the measurement phase are more consistent.
During the measurement phase, the benchmark method executes as many times as it can with the allowed number of threads.
When JMH runs in SampleTime mode (see <code class="docutils literal notranslate"><span class="pre">AtlasDbPerfCli.java</span></code>), a subset of the runs are timed.
JMH will sample as infrequently as it needs to in order to obtain accurate results.
Tests with a long runtime (&gt;10ms) tend to be sampled every run.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Set the <code class="docutils literal notranslate"><span class="pre">&#64;Measurement</span></code> parameters high enough to get at least 100 runs.
The CLI collects percentile statistics and with fewer than 100 samples this data is not particularly useful.</p>
</div>
<p>Benchmark method signatures can also indicate other <code class="docutils literal notranslate"><span class="pre">&#64;State</span></code> objects, for example <code class="docutils literal notranslate"><span class="pre">ConsecutiveNarrowTable</span></code>.
JMH will instantiate these for use in the benchmark.
State annotations specify a <code class="docutils literal notranslate"><span class="pre">Scope</span></code> which describes when the object is created and destroyed.
Similarly, methods in a State object can have functions marked as <code class="docutils literal notranslate"><span class="pre">&#64;Setup</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;Teardown</span></code> with a specified <code class="docutils literal notranslate"><span class="pre">Level</span></code> that describes when to run it.
Check the JMH source code for <code class="docutils literal notranslate"><span class="pre">Scope</span></code> and <code class="docutils literal notranslate"><span class="pre">Level</span></code> for more information.</p>
</section>
<section id="writing-a-new-benchmark">
<h2>Writing a New Benchmark<a class="headerlink" href="#writing-a-new-benchmark" title="Permalink to this heading"></a></h2>
<p>When writing a new benchmark, first consider exactly what you want to test.
If you are looking to test an API endpoint, it might be appropriate to write several benchmarks with each one covering a relevant case.
A good example is the <code class="docutils literal notranslate"><span class="pre">KvsGetRangeBenchmarks.java</span></code> suite, which tests AtlasDB’s <code class="docutils literal notranslate"><span class="pre">getRange()</span></code> in several different ways.</p>
<p>Always include some form of validation in your benchmark.
Validation not only ensures that your code does what you think it does, it also protects against regressions in the benchmarks themselves which can be introduced by changing the underlying State objects.
Validation is often run during the benchmark itself, so care should be taken to avoid expensive operations in it.
Validation that does not include client/server calls generally has a negligible impact on benchmark runtime.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Pass the name of the benchmark you’re working on to the CLI in order to avoid running all benchmarks during development.</p>
</div>
</section>
<section id="benchmarking-with-a-custom-key-value-store-kvs">
<h2>Benchmarking With a Custom Key Value Store (KVS)<a class="headerlink" href="#benchmarking-with-a-custom-key-value-store-kvs" title="Permalink to this heading"></a></h2>
<p>To run the benchmark suite on a custom KVS, simply follow these steps:</p>
<ol class="arabic simple">
<li><p>Extend <code class="docutils literal notranslate"><span class="pre">KeyValueServiceInstrumentation</span></code> with the proper configurations, e.g., see <code class="docutils literal notranslate"><span class="pre">CassandraKeyValueServiceInstrumentation.java</span></code>.</p></li>
<li><p>Register the new backend: <code class="docutils literal notranslate"><span class="pre">KeyValueServiceInstrumentation.addNewBackendType(new</span> <span class="pre">YourKeyValueServiceInstrumentation())</span></code>.</p></li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">AtlasDbPerfCli.main</span></code> function with the desired arguments.</p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="benchmarking.html" class="btn btn-neutral float-left" title="Using The AtlasDB Perf Cli" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../miscellaneous/index.html" class="btn btn-neutral float-right" title="Miscellaneous" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Palantir Technologies.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>