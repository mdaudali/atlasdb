

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Freeing space after sweep &mdash; OSS AtlasDB develop documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=7ab3649f" />
      <link rel="stylesheet" type="text/css" href="../../_static/release-notes.css?v=b943762f" />
      <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css?v=fd4cc2db" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=4191f987"></script>
      <script src="../../_static/doctools.js?v=888ff710"></script>
      <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Standard Sweep" href="standard-sweep.html" />
    <link rel="prev" title="AtlasDB Sweep" href="../sweep.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            OSS AtlasDB
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../schemas/index.html">Schemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../transactions/index.html">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/index.html">Configuration</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Cluster Management</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../clis.html">Command Line Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../console.html">Console</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kvs-migration.html">KVS Migration</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../sweep.html">AtlasDB Sweep</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Freeing space after sweep</a></li>
<li class="toctree-l3"><a class="reference internal" href="standard-sweep.html">Standard Sweep</a></li>
<li class="toctree-l3"><a class="reference internal" href="targeted-sweep.html">Targeted Sweep</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../performance/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../miscellaneous/index.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes/index.html">Releases</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OSS AtlasDB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Cluster Management</a></li>
          <li class="breadcrumb-item"><a href="../sweep.html">AtlasDB Sweep</a></li>
      <li class="breadcrumb-item active">Freeing space after sweep</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/palantir/atlasdb/blob/develop/docs/source/cluster_management/sweep/freeing-space.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="freeing-space-after-sweep">
<span id="freeing-space"></span><h1>Freeing space after sweep<a class="headerlink" href="#freeing-space-after-sweep" title="Permalink to this heading"></a></h1>
<p>The sweep job issues KVS-level deletes to remove stale data.
However, this does not immediately free data, and for Oracle KVS, manual action may be required in order to gain space.</p>
<section id="dbkvs">
<h2>DbKvs<a class="headerlink" href="#dbkvs" title="Permalink to this heading"></a></h2>
<p>DbKvs uses a background compaction thread to free up disk space. Similar to the background sweeper, the background
compactor periodically chooses a table <a class="footnote-reference brackets" href="#tablechoice" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>, and runs <code class="docutils literal notranslate"><span class="pre">KeyValueService.compactInternally</span></code> on that table.</p>
<section id="oracle-standard-edition">
<h3>Oracle - Standard Edition<a class="headerlink" href="#oracle-standard-edition" title="Permalink to this heading"></a></h3>
<p>The background compaction thread runs one of two commands, depending on whether the system is in maintenance mode.
Maintenance mode indicates that users are unlikely to be accessing the system, and so blocking operations can safely be run.
They are configured by a live-reloaded boolean <code class="docutils literal notranslate"><span class="pre">inMaintenanceMode</span></code> (config path <code class="docutils literal notranslate"><span class="pre">runtime/compact/inMaintenanceMode</span></code>)</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code class="docutils literal notranslate"><span class="pre">inMaintenanceMode</span></code> only determines when we <em>start</em> running <code class="docutils literal notranslate"><span class="pre">SHRINK</span> <span class="pre">SPACE</span></code>.
The operation cannot be aborted once started, so it is strongly recommended to allow for a buffer time of up to three hours before database access is required.
For example, if users come online at 9am, then maintenance mode should be disabled by 6am.</p>
</div>
<p>If we are in maintenance mode, then <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span> <span class="pre">table</span> <span class="pre">SHRINK</span> <span class="pre">SPACE</span></code> will be run. This locks the entire table,
meaning that no new transactions can be run on the table until the operation completes.
This is usually fast, but has been seen to take hours on some very large tables.</p>
<p>If we are not in maintenance mode (i.e. we assume users are online), <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span> <span class="pre">table</span> <span class="pre">SHRINK</span> <span class="pre">SPACE</span> <span class="pre">COMPACT</span></code> will be run.
This does not block the table; however, space freed by the operation is only available for use by the same table.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Installations that are never set to maintenance mode may need manual action to free space after <code class="docutils literal notranslate"><span class="pre">SHRINK</span> <span class="pre">SPACE</span> <span class="pre">COMPACT</span></code> has run.
To do this for table <code class="docutils literal notranslate"><span class="pre">foo</span></code>, run <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span> <span class="pre">foo</span> <span class="pre">SHRINK</span> <span class="pre">SPACE</span></code>.
Again, note that this will lock the entire table until the operation completes.</p>
</div>
</section>
<section id="oracle-enterprise">
<h3>Oracle - Enterprise<a class="headerlink" href="#oracle-enterprise" title="Permalink to this heading"></a></h3>
<p>The background compaction thread runs <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span> <span class="pre">table</span> <span class="pre">MOVE</span> <span class="pre">ONLINE</span></code> on the chosen table.
This runs online, and no user action is required.</p>
</section>
<section id="postgres">
<h3>Postgres<a class="headerlink" href="#postgres" title="Permalink to this heading"></a></h3>
<p>The background compaction thread runs <code class="docutils literal notranslate"><span class="pre">VACUUM</span> <span class="pre">ANALYZE</span></code> on the chosen table.
This runs online, and no user action is required.</p>
</section>
</section>
<section id="cassandra-kvs">
<h2>Cassandra KVS<a class="headerlink" href="#cassandra-kvs" title="Permalink to this heading"></a></h2>
<p>The delete operation on Cassandra KVS creates a Cassandra tombstone that prevents the data from being read.
Cassandra uses compactions to free up disk space, which will eventually happen without manual intervention.</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="tablechoice" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>The compactor tracks when each table was last compacted (Tc), and compares those times with the last swept times (Ts), choosing the table with greatest (Ts-Tc), i.e. largest gap between compaction and sweep.</p>
</aside>
</aside>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../sweep.html" class="btn btn-neutral float-left" title="AtlasDB Sweep" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="standard-sweep.html" class="btn btn-neutral float-right" title="Standard Sweep" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Palantir Technologies.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>