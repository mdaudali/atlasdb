

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KVS Migration &mdash; OSS AtlasDB develop documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=7ab3649f" />
      <link rel="stylesheet" type="text/css" href="../_static/release-notes.css?v=b943762f" />
      <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=fd4cc2db" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=4191f987"></script>
      <script src="../_static/doctools.js?v=888ff710"></script>
      <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="AtlasDB Sweep" href="sweep.html" />
    <link rel="prev" title="Console" href="console.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            OSS AtlasDB
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../schemas/index.html">Schemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../transactions/index.html">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration/index.html">Configuration</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Cluster Management</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="clis.html">Command Line Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="console.html">Console</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">KVS Migration</a></li>
<li class="toctree-l2"><a class="reference internal" href="sweep.html">AtlasDB Sweep</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../miscellaneous/index.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes/index.html">Releases</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OSS AtlasDB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Cluster Management</a></li>
      <li class="breadcrumb-item active">KVS Migration</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/palantir/atlasdb/blob/develop/docs/source/cluster_management/kvs-migration.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="kvs-migration">
<span id="id1"></span><h1>KVS Migration<a class="headerlink" href="#kvs-migration" title="Permalink to this heading"></a></h1>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Ensure you have backups before attempting a KVS migration.
Double check that <code class="docutils literal notranslate"><span class="pre">migrateConfig</span></code> (the target KVS) is specified correctly, since all tables in that KVS will be
dropped.</p>
</div>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h2>
<p>KVS migration involves moving all transactional data from one KVS which we call the <em>source KVS</em> to another, which
we call the <em>destination KVS</em>. Generally speaking, this includes all user data.</p>
<p>There are some AtlasDB internal tables which will not be migrated, for various reasons:</p>
<ul class="simple">
<li><p>In some cases, correct operation of AtlasDB does not depend on the contents of these tables.</p></li>
<li><p>In some cases, the migration process obviates the need for these tables (e.g. <code class="docutils literal notranslate"><span class="pre">_transactions</span></code> isn’t needed, because
we simulate writing all of the existing state of the world in a single transaction to the new database).</p></li>
</ul>
<p>These tables include:</p>
<ul class="simple">
<li><p>Atomic tables, as specified in <code class="docutils literal notranslate"><span class="pre">AtlasDbConstants.ATOMIC_TABLES</span></code>. These tables use check and set, and are not
transactional.</p></li>
<li><p>Hidden tables, as specified in <code class="docutils literal notranslate"><span class="pre">AtlasDbConstants.HIDDEN_TABLES</span></code>. These tables may or may not be transactional.</p></li>
<li><p>Cassandra-specific hidden tables, as specified in <code class="docutils literal notranslate"><span class="pre">HiddenTables.CASSANDRA_TABLES</span></code>. These are internal tables used
only by Cassandra KVS, and are not transactional.</p></li>
<li><p>Targeted Sweep tables, as specified in <code class="docutils literal notranslate"><span class="pre">TargetedSweepSchema</span></code>. These tables are not transactional.</p></li>
<li><p>The migration checkpoint table, which is a special table used for checkpointing during migration.</p></li>
</ul>
<p>Due to legacy reasons, we still drop and create some of the internal non-transactional tables. Although these tables
are not migrated automatically, this makes implementation simpler; furthermore, this is safe as far as correctness
is concerned.</p>
<p>Migration itself is performed as a three-step process.</p>
<ol class="arabic simple">
<li><p><strong>Setup</strong>, which prepares the destination KVS for migration as far as DDL operations are concerned.</p></li>
<li><p><strong>Migrate</strong>, which copies the actual data from the source KVS to the destination KVS.</p></li>
<li><p><strong>Validate</strong>, which verifies that data present in the destination KVS matches that in the source KVS.</p></li>
</ol>
<p>If the migration needs to be restarted from scratch, running setup again will reset any previous migration state and
allow a fresh migration.</p>
<p>Migration works by effectively simulating a large transaction that reads the latest version of every cell in every
user table in the source KVS and then writes these cells into the destination KVS. The mechanism we use to do this
is, however, slightly different for operational reasons.</p>
<p>We first take out a fresh timestamp in the source KVS and fast-forward the target KVS to a larger timestamp.
We then take out two fresh timestamps on the destination KVS, which are the start and commit timestamps for the
migration; we then insert (start, commit) into the transactions table of the destination KVS. This commits data
written at the start timestamp at the commit timestamp.</p>
<p>When copying data, we then write the newest versions of each cell in the source KVS to the destination KVS at
the start timestamp. As data is copied over, we also update a checkpoint table, which enables us to continue a failed
migration without starting from scratch.</p>
</section>
<section id="running-a-kvs-migration">
<h2>Running a KVS Migration<a class="headerlink" href="#running-a-kvs-migration" title="Permalink to this heading"></a></h2>
<section id="preconditions">
<h3>Preconditions<a class="headerlink" href="#preconditions" title="Permalink to this heading"></a></h3>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Read this section carefully before performing any migrations! The KVS migration CLI makes some assumptions;
failure to ensure that these assumptions are valid may result in <strong>SEVERE DATA CORRUPTION</strong>.</p>
</div>
<p>While KVS migration is running, the service that is using AtlasDB must continuously be offline; if the service is
running, either some data may be written that will not be migrated over (if the service runs with the source KVS), or
some data that should be present may not be visible (if the service runs with the destination KVS).</p>
<p>If you are using TimeLock, the TimeLock server must be running in order to do the migration, since we need to
obtain migration timestamps.</p>
<p>If you are using embedded services, the <code class="docutils literal notranslate"><span class="pre">--offline</span></code> flag must be used. This will remove the leader block from your
configuration for the purposes of migration.</p>
</section>
<section id="migration-cli">
<h3>Migration CLI<a class="headerlink" href="#migration-cli" title="Permalink to this heading"></a></h3>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you are migrating to/from Oracle KVS and are using a version of AtlasDB before 0.240.10, the standard AtlasDB
CLI distribution will not work as it does not contain the requisite Oracle drivers. Please contact the AtlasDB team
for assistance.</p>
</div>
<p>Migration of all transactional data from one KVS to another can be performed using the <a class="reference internal" href="clis.html#clis"><span class="std std-ref">AtlasDB CLI</span></a>.</p>
<p>To run the migration, the <code class="docutils literal notranslate"><span class="pre">fromConfig</span></code> option should be specified as the path to a file which contains a YAML
representation that has configuration for how Atlas should connect to the source KVS. The <code class="docutils literal notranslate"><span class="pre">migrateConfig</span></code> option
should be specified as the path to a file which contains a YAML representation including configuration for how
Atlas should connect to the destination KVS.</p>
<p>By default, these configurations should be a YAML object where a standard <code class="docutils literal notranslate"><span class="pre">AtlasDbConfig</span></code> is stored underneath
the <code class="docutils literal notranslate"><span class="pre">atlasdb</span></code> key. Users may also specify their own <code class="docutils literal notranslate"><span class="pre">config-root</span></code> (note the case difference). The configurations
may contain unrelated YAML objects. For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">server</span><span class="p">:</span>
<span class="w">  </span><span class="nt">applicationConnectors</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3828</span>
<span class="w">  </span><span class="nt">adminConnectors</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3829</span>

<span class="nt">atlasdb</span><span class="p">:</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">keyValueService</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">memory</span>
</pre></div>
</div>
<p>Running the migration is typically done by invoking the CLI three times, one for each main stage of the migration.</p>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p><strong>ALL</strong> three steps (Setup, Migrate, Validate) must be run before the migration can be considered finished, and the
new KVS used. Failure to do so may result in <strong>SEVERE DATA CORRUPTION</strong>. Please ensure this is the case before
you restart your service with the new KVS.</p>
</div>
</section>
<section id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this heading"></a></h3>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>All tables in the destination KVS will be dropped as part of setup! Please ensure that data there may be safely
deleted.</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./bin/atlasdb-cli<span class="w"> </span>--offline<span class="w"> </span>migrate<span class="w"> </span>--fromConfig<span class="w"> </span>from.yml<span class="w"> </span><span class="o">[</span>--fromRuntimeConfig<span class="w"> </span>fromRuntime.yml<span class="o">]</span><span class="w"> </span>--migrateConfig<span class="w"> </span>to.yml<span class="w"> </span><span class="o">[</span>--migrateRuntimeConfig<span class="w"> </span>toRuntime.yml<span class="o">]</span><span class="w"> </span>--setup
</pre></div>
</div>
<p>Running this command will prepare the target KVS for the migration.
The CLI will first <strong>drop all tables in the target KVS</strong> except atomic tables and Cassandra hidden tables.
Then, for each table in the source KVS except atomic tables and Cassandra hidden tables, a table with the same name and
metadata is created in the target KVS.</p>
</section>
<section id="migrate">
<h3>Migrate<a class="headerlink" href="#migrate" title="Permalink to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./bin/atlasdb-cli<span class="w"> </span>--offline<span class="w"> </span>migrate<span class="w"> </span>--fromConfig<span class="w"> </span>from.yml<span class="w"> </span><span class="o">[</span>--fromRuntimeConfig<span class="w"> </span>fromRuntime.yml<span class="o">]</span><span class="w"> </span>--migrateConfig<span class="w"> </span>to.yml<span class="w"> </span><span class="o">[</span>--migrateRuntimeConfig<span class="w"> </span>toRuntime.yml<span class="o">]</span><span class="w"> </span>--migrate
</pre></div>
</div>
<p>Running this command will migrate the actual data from source KVS to target KVS.
For each table in the source KVS that is not in the list of special tables above, the entire table is transactionally
scanned at the migration timestamp and all entries found are copied over to the target KVS with timestamp equal to the
transaction timestamp.</p>
<p>Note that this will copy over only the most recent version of each cell (as the migration start timestamp is greater
than any timestamp ever issued in the source KVS). Tombstones and deletion sentinels will not be copied over.
Since the migration timestamp was precommitted, even in case of failure, all data that was successfully copied over
may be treated as committed; bear this in mind if one tries to restart the service.
As data is copied over, we regularly update the checkpoint table, which enables us to continue a failed migration
without starting from scratch.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>If a migration fails, it can be restarted from the last checkpoint simply by running the migrate command again.
Running setup at this point will reset the migration state and force a fresh migration.</p>
</div>
</section>
<section id="validate">
<h3>Validate<a class="headerlink" href="#validate" title="Permalink to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./bin/atlasdb-cli<span class="w"> </span>--offline<span class="w"> </span>migrate<span class="w"> </span>--fromConfig<span class="w"> </span>from.yml<span class="w"> </span><span class="o">[</span>--fromRuntimeConfig<span class="w"> </span>fromRuntime.yml<span class="o">]</span><span class="w"> </span>--migrateConfig<span class="w"> </span>to.yml<span class="w"> </span><span class="o">[</span>--migrateRuntimeConfig<span class="w"> </span>toRuntime.yml<span class="o">]</span><span class="w"> </span>--validate
</pre></div>
</div>
<p>Running this command will validate the correctness of the migration.
For each table in the source KVS that can be migrated, except the legacy sweep priority tables, the table is
scanned in both KVSs. Cells and the values associated with them are checked to ensure that they are equal.
The sweep priority table is excluded from this step because, even though it is migrated, the contents of the table in
respective KVSs might diverge as a result of the writes performed during the migration.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>All three commands can be combined in a single invocation of the client, with the caveat that if the migration
fails, care should be taken to identify which step failed before further actions are determined.</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./bin/atlasdb-cli<span class="w"> </span>--offline<span class="w"> </span>migrate<span class="w"> </span>--fromConfig<span class="w"> </span>from.yml<span class="w"> </span>--migrateConfig<span class="w"> </span>to.yml<span class="w"> </span>--setup<span class="w"> </span>--migrate<span class="w"> </span>--validate
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="console.html" class="btn btn-neutral float-left" title="Console" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="sweep.html" class="btn btn-neutral float-right" title="AtlasDB Sweep" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Palantir Technologies.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>