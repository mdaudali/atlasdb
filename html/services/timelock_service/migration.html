<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Migration to Timelock Server &mdash; OSS AtlasDB develop documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/release-notes.css?v=b943762f" />
      <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css?v=fd4cc2db" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=4191f987"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Manual Migration to Timelock Server" href="manual-migration.html" />
    <link rel="prev" title="Timelock Server Installation" href="installation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            OSS AtlasDB
          </a>
              <div class="version">
                develop
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../schemas/index.html">Schemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../transactions/index.html">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cluster_management/index.html">Cluster Management</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Services</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../key_value_services/index.html">Key Value Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lock_service/index.html">Lock Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timestamp_service/index.html">Timestamp Service</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">External Timelock Service</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="installation.html">Timelock Server Installation</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Migration to Timelock Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="manual-migration.html">Manual Migration to Timelock Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="reverse-migration.html">Reverse Migration</a></li>
<li class="toctree-l3"><a class="reference internal" href="product-changes.html">Developing a product to use the timelock service</a></li>
<li class="toctree-l3"><a class="reference internal" href="paxos.html">Paxos and AtlasDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="service-management.html">Service Management</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../performance/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../miscellaneous/index.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes/index.html">Releases</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OSS AtlasDB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Services</a></li>
          <li class="breadcrumb-item"><a href="index.html">External Timelock Service</a></li>
      <li class="breadcrumb-item active">Migration to Timelock Server</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/palantir/atlasdb/blob/develop/docs/source/services/timelock_service/migration.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="migration-to-timelock-server">
<span id="timelock-migration"></span><h1>Migration to Timelock Server<a class="headerlink" href="#migration-to-timelock-server" title="Permalink to this heading"></a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The scope of this document covers migrations of AtlasDB-using services from using an embedded timestamp and lock
service to using TimeLock. In particular, migrations of the timestamp bound persistence method are NOT covered
here, and attempting to do this procedure incorrectly runs a risk of <strong>SEVERE DATA CORRUPTION</strong>.</p>
</div>
<section id="why-migration">
<h2>Why Migration?<a class="headerlink" href="#why-migration" title="Permalink to this heading"></a></h2>
<p>AtlasDB assumes that timestamps returned by the timestamp service are monotonically increasing. In order to preserve
this guarantee when moving from an embedded timestamp service to an external timestamp service, we need to ensure
that timestamps issued by the external timestamp service are larger than those issued by the embedded one.
Otherwise, this can lead to serious data corruption.</p>
</section>
<section id="automated-migration">
<h2>Automated Migration<a class="headerlink" href="#automated-migration" title="Permalink to this heading"></a></h2>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>If your service is highly available, you MUST shut down ALL nodes of your service after step 2 before bringing up any
nodes in step 5. Otherwise, there is a risk of <strong>SEVERE DATA CORRUPTION</strong> as timestamps may be given out of order.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Automated migrations are only implemented for Cassandra, and from AtlasDB 0.253.2 onwards DbKVS.
If you are using any other KVS, please follow the instructions at <a class="reference internal" href="manual-migration.html#manual-timelock-migration"><span class="std std-ref">Manual Migration to Timelock Server</span></a>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If other services are dependent on the timestamp and lock service exposed by the AtlasDB client in question, steps
should be taken to move them to timelock before this service is migrated to timelock, and for those services
a manual migration will be necessary (seeing as they must be using remote timestamp blocks, and/or misusing timelock
configuration to point to those services).</p>
</div>
<ol class="arabic simple">
<li><p>Confirm that your AtlasDB installation is backed by Cassandra KVS, or you are using DbKVS and your version of AtlasDB
is at least 0.253.2.</p></li>
<li><p>(Optional) Take a fresh timestamp from your AtlasDB services, using the fresh timestamp CLI or the
<code class="docutils literal notranslate"><span class="pre">/timestamp/fresh-timestamp</span></code> endpoint. This step is not strictly required, but may be useful for verification.</p></li>
<li><p>Shut down all nodes of your service. These must
remain shut until after step 4 is performed. Failure to do so incurs risks of <strong>SEVERE DATA CORRUPTION</strong> as
timestamps may be given out of order.</p></li>
<li><p>Add the <a class="reference internal" href="../../configuration/external_timelock_service_configs/timelock_client_config.html#timelock-client-configuration"><span class="std std-ref">Timelock client configuration</span></a> to your service.</p></li>
<li><p>Starting/re-starting the service will automatically migrate the service.
Note that the service may not elect a leader until a timestamp or lock request for some client is actually made.</p></li>
</ol>
<section id="verification">
<h3>Verification<a class="headerlink" href="#verification" title="Permalink to this heading"></a></h3>
<p>It may be useful to verify that an automatic migration was carried out successfully. In addition to simply performing
smoke tests of your clients and checking that they still work, there are a few other ways of checking that the
migration occurred correctly.</p>
<ol class="arabic">
<li><p><strong>Request Logs</strong>: Find the TimeLock leader, and search its request logs for calls to the <code class="docutils literal notranslate"><span class="pre">fastForwardTimestamp</span></code>
endpoint. These should be called with a <code class="docutils literal notranslate"><span class="pre">currentTimestamp</span></code> query parameter, which should be the bound in the
embedded timestamp bound store before the migration.</p>
<p>This bound should be noted down before an upgrade, perhaps with <code class="docutils literal notranslate"><span class="pre">cqlsh</span></code> or other interface to the DB:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cqlsh&gt; USE keyspace;
cqlsh:keyspace&gt; SELECT * FROM &quot;_timestamp&quot;;

 key    | column1 | column2 | value
--------+---------+---------+---------------------
 0x7473 |  0x7473 |      -1 | 0x0001020304050607
</pre></div>
</div>
<p>Otherwise, if using Cassandra we can attempt to determine this bound, by finding the most recent occurrence of
<code class="docutils literal notranslate"><span class="pre">[CAS]</span> <span class="pre">Setting</span> <span class="pre">cached</span> <span class="pre">limit</span> <span class="pre">to</span> <span class="pre">{}.</span></code> in the AtlasDB client logs (across all AtlasDB clients). Note that this is
logged at INFO level by the <a class="reference internal" href="../../configuration/logging.html#debug-logging"><span class="std std-ref">DebugLogger</span></a>, so if you have directed that to a separate
appender you will need to search in those logs instead.</p>
</li>
<li><p><strong>Key-Value Service table state</strong>: Check the state of the key-value service. For Cassandra, you should expect
to see two rows: <code class="docutils literal notranslate"><span class="pre">oldTs</span></code> (the backed up value of the timestamp bound) and
<code class="docutils literal notranslate"><span class="pre">ts</span></code> (a bogus one byte array indicating that the timestamp table has been invalidated). The <code class="docutils literal notranslate"><span class="pre">oldTs</span></code> value
should match the <code class="docutils literal notranslate"><span class="pre">currentTimestamp</span></code> values in the request logs.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cqlsh&gt; USE keyspace;
cqlsh:keyspace&gt; SELECT * FROM &quot;_timestamp&quot;;

 key    | column1      | column2 | value
--------+--------------+---------+---------------------
 0x7473 | 0x6f6c645473 |      -1 | 0x0001020304050607
 0x7473 |       0x7473 |      -1 |               0x00
</pre></div>
</div>
<p>We store timestamps as blobs in Cassandra, but the entry in the request logs is in decimal. One way of checking
they are equal is by converting the <code class="docutils literal notranslate"><span class="pre">oldTs</span></code> value to decimal through the shell:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo $((0x0001020304050607))
283686952306183
</pre></div>
</div>
</li>
<li><p><strong>AtlasDB Client Logs</strong>: Search for <code class="docutils literal notranslate"><span class="pre">[BACKUP]</span> <span class="pre">Backed</span> <span class="pre">up</span> <span class="pre">the</span> <span class="pre">value</span> <span class="pre">{}</span></code> in the AtlasDB client logs. This should
occur precisely once, and the value should match that as retrieved by the aforementioned methods.</p></li>
</ol>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="installation.html" class="btn btn-neutral float-left" title="Timelock Server Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="manual-migration.html" class="btn btn-neutral float-right" title="Manual Migration to Timelock Server" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Palantir Technologies.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>