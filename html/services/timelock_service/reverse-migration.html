

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reverse Migration &mdash; OSS AtlasDB develop documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=7ab3649f" />
      <link rel="stylesheet" type="text/css" href="../../_static/release-notes.css?v=b943762f" />
      <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css?v=fd4cc2db" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=4191f987"></script>
      <script src="../../_static/doctools.js?v=888ff710"></script>
      <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Developing a product to use the timelock service" href="product-changes.html" />
    <link rel="prev" title="Manual Migration to Timelock Server" href="manual-migration.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            OSS AtlasDB
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../schemas/index.html">Schemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../transactions/index.html">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cluster_management/index.html">Cluster Management</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Services</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../key_value_services/index.html">Key Value Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lock_service/index.html">Lock Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timestamp_service/index.html">Timestamp Service</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">External Timelock Service</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="installation.html">Timelock Server Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="migration.html">Migration to Timelock Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="manual-migration.html">Manual Migration to Timelock Server</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Reverse Migration</a></li>
<li class="toctree-l3"><a class="reference internal" href="product-changes.html">Developing a product to use the timelock service</a></li>
<li class="toctree-l3"><a class="reference internal" href="paxos.html">Paxos and AtlasDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="service-management.html">Service Management</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../performance/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../miscellaneous/index.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes/index.html">Releases</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OSS AtlasDB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Services</a></li>
          <li class="breadcrumb-item"><a href="index.html">External Timelock Service</a></li>
      <li class="breadcrumb-item active">Reverse Migration</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/palantir/atlasdb/blob/develop/docs/source/services/timelock_service/reverse-migration.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="reverse-migration">
<span id="timelock-reverse-migration"></span><h1>Reverse Migration<a class="headerlink" href="#reverse-migration" title="Permalink to this heading"></a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Many Atlas clients switched to using TimeLock by default many versions after it was first reasonable to use Atlas with TimeLock.
If you are on this page because you were directed to it by an error stating “This can happen if you attempt to run AtlasDB without a timelock block after having previously migrated to the TimeLock server”, then please <a class="reference internal" href="../../configuration/external_timelock_service_configs/timelock_client_config.html#timelock-client-configuration"><span class="std std-ref">configure your service</span></a> to use TimeLock rather than attempting a reverse migration.</p>
</div>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Improperly executing reverse migration from external timestamp and lock services can result in
<strong>SEVERE DATA CORRUPTION</strong>! Please contact the AtlasDB team before attempting a reverse migration.</p>
</div>
<p>While the migration from an embedded to external timelock service is automatic, the reverse is a manual process. The
steps are the inverse of <a class="reference internal" href="manual-migration.html#manual-timelock-migration"><span class="std std-ref">Manual Migration to Timelock Server</span></a>, with an additional step to update the timestamp bound of the
embedded service.</p>
<p>The reverse migration process must be run offline (with no AtlasDB clients for the client you are reverse-migrating
running). We do not currently protect against accidentally not running this process offline.
Throughout this document, we assume the AtlasDB client you are trying to reverse-migrate is <code class="docutils literal notranslate"><span class="pre">client</span></code> .</p>
<ol class="arabic simple">
<li><p>Shut down your AtlasDB clients for <code class="docutils literal notranslate"><span class="pre">client</span></code> .</p></li>
<li><p>Take a restore timestamp.</p></li>
<li><p>Revert your AtlasDB client configuration.</p></li>
<li><p>Restart the TimeLock servers.</p></li>
<li><p>Update your key-value service to the restore timestamp.</p></li>
<li><p>Start your AtlasDB clients.</p></li>
</ol>
<section id="step-1-shut-down-atlasdb-clients">
<h2>Step 1: Shut Down AtlasDB Clients<a class="headerlink" href="#step-1-shut-down-atlasdb-clients" title="Permalink to this heading"></a></h2>
<p>Make sure that your AtlasDB clients for <code class="docutils literal notranslate"><span class="pre">client</span></code> are shut down. Failure to do this can result in severe data
corruption, because we cannot guarantee that the Timelock Server and the embedded AtlasDB timestamp services will
together issue monotonically increasing timestamps.</p>
</section>
<section id="step-2-take-a-restore-timestamp">
<h2>Step 2: Take a Restore Timestamp<a class="headerlink" href="#step-2-take-a-restore-timestamp" title="Permalink to this heading"></a></h2>
<p>Obtain a fresh timestamp for <code class="docutils literal notranslate"><span class="pre">client</span></code> from the TimeLock servers. This is important to ensure that the sequence
of timestamps across TimeLock and the key-value service backed services is monotonically increasing.</p>
<p>This can be obtained using <code class="docutils literal notranslate"><span class="pre">curl</span></code> as follows. Note that if you obtain an HTTP 503 error, this is because you curled a
node that was not the leader; please try the other nodes.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-XPOST<span class="w"> </span>&lt;protocol&gt;://&lt;host&gt;:&lt;port&gt;/timelock/api/tl/ts/&lt;namespace&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data<span class="w"> </span><span class="s1">&#39;{&quot;numTimestamps&quot;: 1}&#39;</span><span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer q&quot;</span><span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span>
</pre></div>
</div>
</div></blockquote>
<p>Note down the value returned from this call; we’ll refer to it as <code class="docutils literal notranslate"><span class="pre">TS</span></code> from here on.</p>
</section>
<section id="step-3-revert-atlasdb-client-configurations">
<h2>Step 3: Revert AtlasDB Client Configurations<a class="headerlink" href="#step-3-revert-atlasdb-client-configurations" title="Permalink to this heading"></a></h2>
<p>Remove the <code class="docutils literal notranslate"><span class="pre">timelock</span></code> block from your AtlasDB client configurations. For more detail on options
for using embedded timestamp and lock services, please consult <a class="reference internal" href="../../configuration/leader_config.html#leader-config"><span class="std std-ref">Leader Config</span></a>.</p>
</section>
<section id="step-4-start-your-timelock-servers">
<h2>Step 4: Start your TimeLock Servers<a class="headerlink" href="#step-4-start-your-timelock-servers" title="Permalink to this heading"></a></h2>
<p>Start your TimeLock servers. Other services that were still dependent on TimeLock (if any) should now
work normally. This step is placed here to minimise downtime for other services that may be running against TimeLock.</p>
</section>
<section id="step-5-update-your-key-value-service">
<h2>Step 5: Update your Key-Value Service<a class="headerlink" href="#step-5-update-your-key-value-service" title="Permalink to this heading"></a></h2>
<p>Update the timestamp table in your key value service, such that it is valid and has the bound set to <code class="docutils literal notranslate"><span class="pre">TS</span></code> .
This will vary depending on your choice of key-value service:</p>
<ul>
<li><p>If you are using <strong>Cassandra</strong>, then you can carry out the following steps.
We suppose that your clients have the keyspace <code class="docutils literal notranslate"><span class="pre">client</span></code> in the examples below; at a high level, we want to truncate
the timestamp table to remove all entries, and then add a single entry with row and column names <code class="docutils literal notranslate"><span class="pre">0x7473</span></code>
(case-sensitive) and a blob value indicating the actual timestamp.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cqlsh&gt; USE client;
cqlsh:client&gt; CONSISTENCY QUORUM;
Consistency level set to QUORUM.
cqlsh:client&gt; SELECT * FROM &quot;_timestamp&quot; ;

 key    | column1      | column2 | value
--------+--------------+---------+--------------------
 0x7473 | 0x6f6c645473 |      -1 | 0x0000000006d30af4
 0x7473 |       0x7473 |      -1 |               0x00

(2 rows)

cqlsh:client&gt; TRUNCATE &quot;_timestamp&quot;;
cqlsh:client&gt; SELECT * FROM &quot;_timestamp&quot; ;

 key | column1 | column2 | value
-----+---------+---------+-------

(0 rows)
</pre></div>
</div>
<p>You will need to encode <code class="docutils literal notranslate"><span class="pre">TS</span></code> into an 8-byte hex representation; this can be done using the <code class="docutils literal notranslate"><span class="pre">printf</span></code> shell command.
Additionally, you can confirm that the existing hex value is smaller than the one you are setting the table to:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ printf &#39;0x%016x\n&#39; 123456789 # new value in hex
0x00000000075bcd15

$ echo $((0x0000000006d30af4)) # old
114494196

cqlsh:client&gt; INSERT INTO &quot;_timestamp&quot; (key, column1, column2, value) VALUES (0x7473, 0x7473, -1, 0x00000000075bcd15);
cqlsh:client&gt; SELECT * FROM &quot;_timestamp&quot; ;

 key    | column1 | column2 | value
--------+---------+---------+--------------------
 0x7473 |  0x7473 |      -1 | 0x00000000075bcd15
</pre></div>
</div>
</li>
<li><p>If you are using DBKVS and have followed the steps outlined in <a class="reference internal" href="manual-migration.html#manual-timelock-migration"><span class="std std-ref">Manual TimeLock Migration</span></a>,
you will first want to rename the column back to its original name.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">RENAME</span><span class="w"> </span><span class="n">LEGACY_last_allocated</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">last_allocated</span><span class="p">;</span>
</pre></div>
</div>
<p>After that, you will want to set the value stored in that table in the database to be <code class="docutils literal notranslate"><span class="pre">TS</span></code>.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">a_db</span><span class="o">=#</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">_timestamp</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">last_allocated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">314159265</span><span class="p">;</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="mi">1</span>
<span class="n">a_db</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">_timestamp</span><span class="p">;</span>
<span class="w"> </span><span class="n">last_allocated</span>
<span class="c1">----------------</span>
<span class="w">      </span><span class="mi">314159265</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="step-6-start-your-atlasdb-clients">
<h2>Step 6: Start your AtlasDB Clients<a class="headerlink" href="#step-6-start-your-atlasdb-clients" title="Permalink to this heading"></a></h2>
<p>Finally, start your AtlasDB clients. At this point, it may be useful to perform a simple smoke test to verify that your
clients work properly or curl the embedded timestamp service to confirm timestamps are greater than your restore
timestamp from above.</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ curl -XPOST https://&lt;client-host&gt;:&lt;application-port&gt;&lt;application-context-path&gt;/timestamp/fresh-timestamp
123456790 # greater than restore timestamp
</pre></div>
</div>
</div></blockquote>
<p>This completes the reverse migration process.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="manual-migration.html" class="btn btn-neutral float-left" title="Manual Migration to Timelock Server" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="product-changes.html" class="btn btn-neutral float-right" title="Developing a product to use the timelock service" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Palantir Technologies.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>