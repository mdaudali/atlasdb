

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manual Migration to Timelock Server &mdash; OSS AtlasDB develop documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/release-notes.css?v=b943762f" />
      <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css?v=fd4cc2db" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=4191f987"></script>
      <script src="../../_static/doctools.js?v=888ff710"></script>
      <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Reverse Migration" href="reverse-migration.html" />
    <link rel="prev" title="Migration to Timelock Server" href="migration.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            OSS AtlasDB
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../schemas/index.html">Schemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../transactions/index.html">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cluster_management/index.html">Cluster Management</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Services</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../key_value_services/index.html">Key Value Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lock_service/index.html">Lock Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timestamp_service/index.html">Timestamp Service</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">External Timelock Service</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="installation.html">Timelock Server Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="migration.html">Migration to Timelock Server</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Manual Migration to Timelock Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="reverse-migration.html">Reverse Migration</a></li>
<li class="toctree-l3"><a class="reference internal" href="product-changes.html">Developing a product to use the timelock service</a></li>
<li class="toctree-l3"><a class="reference internal" href="paxos.html">Paxos and AtlasDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="service-management.html">Service Management</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../performance/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../miscellaneous/index.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes/index.html">Releases</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OSS AtlasDB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Services</a></li>
          <li class="breadcrumb-item"><a href="index.html">External Timelock Service</a></li>
      <li class="breadcrumb-item active">Manual Migration to Timelock Server</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/palantir/atlasdb/blob/develop/docs/source/services/timelock_service/manual-migration.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="manual-migration-to-timelock-server">
<span id="manual-timelock-migration"></span><h1>Manual Migration to Timelock Server<a class="headerlink" href="#manual-migration-to-timelock-server" title="Permalink to this heading"></a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This is not a recommended way to migrate to external timelock server.
We now have automated migrations for both Cassandra and DbKVS in place that will run when a node is started with
the configuration to use TimeLock on versions of AtlasDB from 0.253.2 onwards. Please note that these automated
migrations still require the cluster to be brought to a complete shutdown before any nodes switch to using TimeLock.
If you are attempting a manual migration, please contact the AtlasDB team.</p>
</div>
<p>This migration process must be run offline (that is, with no AtlasDB clients running during migration) and basically
consists of the following steps:</p>
<ol class="arabic simple">
<li><p>Set up the external timestamp service.</p></li>
<li><p>Obtain a timestamp <code class="docutils literal notranslate"><span class="pre">TS</span></code> from the service that is at least as large as the largest timestamp issued.</p></li>
<li><p>Fast-forward the external timestamp service to at least <code class="docutils literal notranslate"><span class="pre">TS</span></code> for the service.</p></li>
<li><p>Invalidate the old timestamp service, preventing AtlasDB clients from retrieving timestamps from it.</p></li>
<li><p>Configure AtlasDB clients to retrieve timestamps from the new timestamp service.</p></li>
<li><p>Start AtlasDB clients.</p></li>
</ol>
<p>Strictly speaking, step 4, invalidating the timestamp service, is not required; that said, we prefer to do this to avoid
the risk of data corruption in the event of misconfiguration (that is, if some but not all clients are pointed to the
new timestamp service).</p>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Ensure that no AtlasDB clients are running during the migration process. Failure to ensure this can result in
<strong>SEVERE DATA CORRUPTION</strong> as we are unable to guarantee that timestamps are monotonically increasing!</p>
</div>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#step-0-shutdown-your-atlasdb-clients" id="id1">Step 0: Shutdown your AtlasDB Clients</a></p></li>
<li><p><a class="reference internal" href="#step-1-setting-up-the-timelock-server" id="id2">Step 1: Setting up the Timelock Server</a></p></li>
<li><p><a class="reference internal" href="#step-2-determining-the-atlasdb-timestamp" id="id3">Step 2: Determining the AtlasDB Timestamp</a></p></li>
<li><p><a class="reference internal" href="#step-3-fast-forwarding-the-timelock-server" id="id4">Step 3: Fast-Forwarding the Timelock Server</a></p></li>
<li><p><a class="reference internal" href="#step-4-invalidating-the-old-atlasdb-timestamp" id="id5">Step 4: Invalidating the Old AtlasDB Timestamp</a></p></li>
<li><p><a class="reference internal" href="#steps-5-and-6-client-configuration-and-restart" id="id6">Steps 5 and 6: Client Configuration and Restart</a></p></li>
</ul>
</nav>
<section id="step-0-shutdown-your-atlasdb-clients">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Step 0: Shutdown your AtlasDB Clients</a><a class="headerlink" href="#step-0-shutdown-your-atlasdb-clients" title="Permalink to this heading"></a></h2>
<p>Make sure that all of your AtlasDB clients are shut down. Failure to do this can result in severe data corruption,
because we cannot guarantee that the Timelock Server and the embedded AtlasDB timestamp services will together issue
monotonically increasing timestamps. (In fact, they almost certainly will not!)</p>
</section>
<section id="step-1-setting-up-the-timelock-server">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Step 1: Setting up the Timelock Server</a><a class="headerlink" href="#step-1-setting-up-the-timelock-server" title="Permalink to this heading"></a></h2>
<p>First, setup the Timelock Server following the instructions in <a class="reference internal" href="installation.html#timelock-installation"><span class="std std-ref">Timelock Server Installation</span></a>.</p>
</section>
<section id="step-2-determining-the-atlasdb-timestamp">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Step 2: Determining the AtlasDB Timestamp</a><a class="headerlink" href="#step-2-determining-the-atlasdb-timestamp" title="Permalink to this heading"></a></h2>
<p>One can use the <a class="reference internal" href="../../cluster_management/clis.html#clis"><span class="std std-ref">Command Line Utilities</span></a> (specifically, the <code class="docutils literal notranslate"><span class="pre">timestamp</span> <span class="pre">fetch</span></code> command) to obtain a timestamp which is guaranteed
to be greater than all timestamps issued so far. Make sure that you are requesting for a fresh timestamp as opposed to
an immutable timestamp (the output should say <code class="docutils literal notranslate"><span class="pre">The</span> <span class="pre">Fresh</span> <span class="pre">timestamp</span> <span class="pre">is:</span> <span class="pre">TS</span></code>). Note down the value of this timestamp;
from here on out, we’ll refer to it as <code class="docutils literal notranslate"><span class="pre">TS</span></code>.</p>
</section>
<section id="step-3-fast-forwarding-the-timelock-server">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Step 3: Fast-Forwarding the Timelock Server</a><a class="headerlink" href="#step-3-fast-forwarding-the-timelock-server" title="Permalink to this heading"></a></h2>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Throughout this document, <code class="docutils literal notranslate"><span class="pre">curl</span></code> commands that make requests to TimeLock may receive a 308 indicating the location
of the leader, or a 503 indicating that a node is not the leader (and doesn’t know this). Commands should be re-run
until they succeed on the leader.</p>
</div>
<p>The Timelock Server exposes an administrative interface, which features a <code class="docutils literal notranslate"><span class="pre">fast-forward</span></code> endpoint. Note that this is
not typically exposed to AtlasDB clients. One can use it to advance the timestamp on the Timelock Server to <code class="docutils literal notranslate"><span class="pre">TS</span></code>, as
follows:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-iXPOST<span class="w"> </span>&lt;protocol&gt;://&lt;host&gt;:&lt;port&gt;/timelock/api/&lt;namespace&gt;/timestamp-management/fast-forward?currentTimestamp<span class="o">=</span>TS<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer q&quot;</span>
</pre></div>
</div>
</div></blockquote>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Make sure that <code class="docutils literal notranslate"><span class="pre">TS</span></code> has been entered correctly.</p>
<blockquote>
<div><ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">TS</span></code> entered is too large, there will generally not be adverse consequences (apart from risks of <code class="docutils literal notranslate"><span class="pre">long</span></code>
overflow). If this is indeed a concern (e.g. there was an accidental fast-forward to <code class="docutils literal notranslate"><span class="pre">Long.MAX_VALUE</span></code>), then
one can proceed by shutting down the Timelock server, deleting the Paxos data directories for the client
concerned (which resets the client timestamp to zero), restarting the Timelock server and attempting the
fast-forward again.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">TS</span></code> entered is too small and AtlasDB clients are restarted without rectifying this, this can result in
<strong>SEVERE DATA CORRUPTION</strong> because we lose the guarantee that timestamps are monotonically increasing.
As fast-forward is idempotent (it sets the timestamp to be the maximum of its current value and the
<code class="docutils literal notranslate"><span class="pre">newMinimum</span></code>), <em>if clients have not been started again</em> this can be fixed by doing another fast-forward.</p></li>
</ul>
</div></blockquote>
</div>
<p>To verify that this step was completed correctly, you may curl the Timelock Server’s fresh-timestamp endpoint.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-iXPOST<span class="w"> </span>&lt;protocol&gt;://&lt;host&gt;:&lt;port&gt;/timelock/api/tl/ts/&lt;namespace&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data<span class="w"> </span><span class="s1">&#39;{&quot;numTimestamps&quot;: 1}&#39;</span><span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer q&quot;</span><span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span>
</pre></div>
</div>
</div></blockquote>
<p>The value returned should be (assuming no one else is using the Timelock Server) 1 higher than <code class="docutils literal notranslate"><span class="pre">TS</span></code>.</p>
</section>
<section id="step-4-invalidating-the-old-atlasdb-timestamp">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Step 4: Invalidating the Old AtlasDB Timestamp</a><a class="headerlink" href="#step-4-invalidating-the-old-atlasdb-timestamp" title="Permalink to this heading"></a></h2>
<p>The steps for invalidating the old AtlasDB timestamp will vary, depending on your choice of underlying key value store.</p>
<ul>
<li><p>If using Postgres or Oracle, it suffices to rename the relevant column in the timestamp table (use <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span></code>).
For example, for Postgres:</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">RENAME</span><span class="w"> </span><span class="n">last_allocated</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">LEGACY_last_allocated</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>If using Cassandra, one method of invalidating the table is to overwrite the timestamp bound record with an invalid
byte array. We recommend using a bogus one-byte array for this; the zero byte array is a deletion sentinel, and
if supplying byte arrays longer than 8 bytes, we will interpret the first 8 bytes as the timestamp bound.
Automated migration is implemented in this way as well (though we use Cassandra’s lightweight transactions for
the automated migration, to be resilient to server lag when restarting an AtlasDB client’s cluster with a Timelock
block for the first time).
This can be done easily using <code class="docutils literal notranslate"><span class="pre">cqlsh</span></code>. The timestamp table is stored in the same keyspace that your
AtlasDB client uses for its key-value service.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>SELECT<span class="w"> </span>*<span class="w"> </span>FROM<span class="w"> </span>atlasdb.<span class="s2">&quot;_timestamp&quot;</span><span class="p">;</span>
&lt;note<span class="w"> </span>the<span class="w"> </span>value<span class="w"> </span>returned<span class="w"> </span>by<span class="w"> </span>this<span class="w"> </span>-<span class="w"> </span>call<span class="w"> </span>this<span class="w"> </span>K&gt;
INSERT<span class="w"> </span>INTO<span class="w"> </span>atlasdb.<span class="s2">&quot;_timestamp&quot;</span><span class="w"> </span><span class="o">(</span>key,<span class="w"> </span>column1,<span class="w"> </span>column2,<span class="w"> </span>value<span class="o">)</span><span class="w"> </span>VALUES<span class="w"> </span><span class="o">(</span>0x7473,<span class="w"> </span>0x7472,<span class="w"> </span>-1,<span class="w"> </span>K<span class="o">)</span><span class="p">;</span>
INSERT<span class="w"> </span>INTO<span class="w"> </span>atlasdb.<span class="s2">&quot;_timestamp&quot;</span><span class="w"> </span><span class="o">(</span>key,<span class="w"> </span>column1,<span class="w"> </span>column2,<span class="w"> </span>value<span class="o">)</span><span class="w"> </span>VALUES<span class="w"> </span><span class="o">(</span>0x7473,<span class="w"> </span>0x7473,<span class="w"> </span>-1,<span class="w"> </span>0x00<span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Dropping the table, generally speaking, will <em>not</em> work (on the next startup of an embedded Timestamp Service,
AtlasDB will believe it is starting up the Timestamp Service for the first time, and thus start again from 1).</p></li>
<li><p>Setting the value to <code class="docutils literal notranslate"><span class="pre">Long.MAX_VALUE</span></code> or <code class="docutils literal notranslate"><span class="pre">Long.MIN_VALUE</span></code> will not work (Java Longs do not throw on arithmetic
overflow, and although ordinarily the first timestamp AtlasDB issues is 1 we do not throw on negative numbers).</p></li>
</ul>
<p>Please contact the AtlasDB team for assistance if you are uncertain about this step or otherwise run into difficulties.</p>
<p>To verify that this step was completed successfully, you may restart one of your AtlasDB clients. This should fail when
TransactionManagers.create() is called, throwing a runtime exception.</p>
</section>
<section id="steps-5-and-6-client-configuration-and-restart">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Steps 5 and 6: Client Configuration and Restart</a><a class="headerlink" href="#steps-5-and-6-client-configuration-and-restart" title="Permalink to this heading"></a></h2>
<p>Configure your clients to use the Timelock Server following the instructions in <a class="reference internal" href="../../configuration/external_timelock_service_configs/timelock_client_config.html#timelock-client-configuration"><span class="std std-ref">Timelock Client Configuration</span></a>.
You may then restart your clients; they should now communicate with the Timelock Server when requesting timestamps
and locks. This completes the migration process.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="migration.html" class="btn btn-neutral float-left" title="Migration to Timelock Server" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="reverse-migration.html" class="btn btn-neutral float-right" title="Reverse Migration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Palantir Technologies.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>