

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dynamic Columns &mdash; OSS AtlasDB develop documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=7ab3649f" />
      <link rel="stylesheet" type="text/css" href="../_static/release-notes.css?v=b943762f" />
      <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=fd4cc2db" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=4191f987"></script>
      <script src="../_static/doctools.js?v=888ff710"></script>
      <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Streams" href="streams.html" />
    <link rel="prev" title="Cassandra Best Practices" href="best_practices.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            OSS AtlasDB
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Schemas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="tables_and_indices.html">Tables and Indices</a></li>
<li class="toctree-l2"><a class="reference internal" href="best_practices.html">Cassandra Best Practices</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Dynamic Columns</a></li>
<li class="toctree-l2"><a class="reference internal" href="streams.html">Streams</a></li>
<li class="toctree-l2"><a class="reference internal" href="cleanup_tasks.html">Cleanup Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="physical_cleanup.html">Physical Cleanup</a></li>
<li class="toctree-l2"><a class="reference internal" href="migrating_schemas.html">Schema Migrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="oracle_table_mapping.html">Oracle Table Mapping</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../transactions/index.html">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster_management/index.html">Cluster Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../miscellaneous/index.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes/index.html">Releases</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OSS AtlasDB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Schemas</a></li>
      <li class="breadcrumb-item active">Dynamic Columns</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/palantir/atlasdb/blob/develop/docs/source/schemas/dynamic_columns.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="dynamic-columns">
<h1>Dynamic Columns<a class="headerlink" href="#dynamic-columns" title="Permalink to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This document discusses AtlasDB’s dynamic columns. This is a separate concept from Cassandra’s dynamic columns;
in fact, AtlasDB’s schemas in Cassandra always use two Cassandra dynamic columns, independent of whether
we are storing a fixed-columns or dynamic columns table! Throughout this document, where “dynamic columns” is
used unqualified, we refer to AtlasDB dynamic columns.</p>
</div>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h2>
<p>AtlasDB offers support for <em>dynamic columns</em> - in tables where these are enabled, rows that can have an arbitrary number
of columns, each with a (typed) column name. A table with dynamic columns may be reasoned about as a
<code class="docutils literal notranslate"><span class="pre">Map&lt;RowKey,</span> <span class="pre">SortedMap&lt;Tuple&lt;Col1,</span> <span class="pre">Col2...</span> <span class="pre">ColN&gt;,</span> <span class="pre">Value&gt;&gt;</span></code>. It may also be thought of as a collection of key-value
pairs within a row. For example, a simple schema using dynamic columns may be defined as follows:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">schema</span><span class="p">.</span><span class="na">addTableDefinition</span><span class="p">(</span><span class="s">&quot;todo&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TableDefinition</span><span class="p">()</span><span class="w"> </span><span class="p">{{</span>
<span class="w">            </span><span class="n">rowName</span><span class="p">();</span>
<span class="w">                </span><span class="n">rowComponent</span><span class="p">(</span><span class="s">&quot;person&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="p">.</span><span class="na">STRING</span><span class="p">);</span>
<span class="w">            </span><span class="n">dynamicColumns</span><span class="p">();</span>
<span class="w">                </span><span class="n">columnComponent</span><span class="p">(</span><span class="s">&quot;taskSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="p">.</span><span class="na">VAR_LONG</span><span class="p">);</span>
<span class="w">                </span><span class="n">columnComponent</span><span class="p">(</span><span class="s">&quot;monetaryCost&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="p">.</span><span class="na">VAR_LONG</span><span class="p">);</span>
<span class="w">                </span><span class="n">value</span><span class="p">(</span><span class="n">ValueType</span><span class="p">.</span><span class="na">STRING</span><span class="p">);</span>
<span class="w">        </span><span class="p">}});</span>
</pre></div>
</div>
<p>Note that dynamic column components must be primitive ValueTypes which support partitioning and ordering.
Also, key-value pairs in an individual row will be returned in <em>lexicographically</em> sorted order of the key.</p>
<p>We call the person the <em>row key</em>, the (taskSize, monetaryCost) pair the <em>dynamic column key</em>, and the string (which is
intended to be a description of the todo) the <em>value</em>.</p>
</section>
<section id="query-capabilities">
<h2>Query Capabilities<a class="headerlink" href="#query-capabilities" title="Permalink to this heading"></a></h2>
<p>Dynamic Columns are useful for avoiding row range scans, especially in key-value services where these
are expensive (like Cassandra - its caching optimisations are rendered ineffectual for row range scans). Furthermore,
when considering whether a query without row range scans will be performant, it is worth considering how each row is
laid out in the database. Generally, queries for column ranges that are contiguous are more efficient, though there are
exceptions to this rule (such as query 4).</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Dynamic Column Key</p></th>
<th class="head"><p>Dynamic Column Value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>(1, 3000)</p></td>
<td><p>“Buy a bitcoin”</p></td>
</tr>
<tr class="row-odd"><td><p>(2, 0)</p></td>
<td><p>“Review pull request”</p></td>
</tr>
<tr class="row-even"><td><p>(2, 1)</p></td>
<td><p>“Get coffee”</p></td>
</tr>
<tr class="row-odd"><td><p>(3, 0)</p></td>
<td><p>“Write docs for dynamic columns”</p></td>
</tr>
<tr class="row-even"><td><p>(3, 6)</p></td>
<td><p>“Get lunch”</p></td>
</tr>
<tr class="row-odd"><td><p>(5, -1)</p></td>
<td><p>“Complete online survey”</p></td>
</tr>
<tr class="row-even"><td><p>(5, 0)</p></td>
<td><p>“Resolve merge conflicts”</p></td>
</tr>
<tr class="row-odd"><td><p>(6, 10)</p></td>
<td><p>“Take a train out of the city”</p></td>
</tr>
<tr class="row-even"><td><p>(7, 2)</p></td>
<td><p>“Do laundry”</p></td>
</tr>
<tr class="row-odd"><td><p>(7, 7)</p></td>
<td><p>“Visit the supermarket”</p></td>
</tr>
<tr class="row-even"><td><p>(7, 42)</p></td>
<td><p>“Watch a musical”</p></td>
</tr>
</tbody>
</table>
<p>For example, for the schema defined above:</p>
<ol class="arabic simple">
<li><p>“Find John’s smallest and cheapest todo” can be answered very efficiently.
Elements are stored in sorted order, so the very first key-value pair retrieved from the database is actually the
correct answer to this query.</p></li>
<li><p>“Find all of Tom’s todos with size up to M, limited to N results” is easy, as this can be
processed with a natural stopping point, as in query 1, and we are iterating in the right order for this query.
This can be achieved using the <code class="docutils literal notranslate"><span class="pre">getRowsColumnRange</span></code> API.</p></li>
<li><p>“Find all of Tom’s todos with size of 10 to 15, limit to N results” can be performed via a range
scan on the dynamic column key. This is also readily supported, and does not require a row range scan.</p></li>
<li><p>“Find all of Tom’s largest todos” is somewhat more difficult, as reverse range scans aren’t supported by the
dynamic columns API. If we were more interested in largest todos as opposed to smallest, we could set the
<code class="docutils literal notranslate"><span class="pre">ValueByteOrder</span></code> of the <code class="docutils literal notranslate"><span class="pre">taskSize</span></code> column component to decreasing.</p></li>
<li><p>“Find all of Tom’s todos which cost less than 5” will be less efficient. We need to retrieve the entire row to do
this, because the map is sorted by task size and then monetary cost. If queries on cost are more common than queries
on size, flipping the order of the column components could help.</p></li>
<li><p>“Find all of Tom’s todos which have size between 3 and 7, and cost between 5 and 10”. We have to visit column ranges
in contiguous order, so if we write a single query we need to scan from (3, 5) to (7, 10 + 1). However, this range
also includes values we are not interested in (any values with size 4-6 that don’t fit in the cost range, and also
costly size 3 tasks and cheap size 7 tasks). We can postfilter them out, but we still need to scan through them.</p></li>
<li><p>“Find all of Nathan’s todos that begin with the letter N”. Prefix / range scans are not supported on values, so this
requires us to scan through the entire row.</p></li>
<li><p>“Find all of John’s and Jeremy’s smallest todos” is easy - this is doing the query “find a person’s smallest todos”
twice. To answer that query, we can scan through the person’s tasks until we find one with a larger size than the
others we have seen so far. At that point, we know we have seen all the smallest tasks (because it is in sorted
order).</p></li>
<li><p>“Find the smallest todos for everyone whose name begins with J” is NOT easy. While this
conceivably can be split into two parts (a row prefix scan for J, and then the aforementioned
<code class="docutils literal notranslate"><span class="pre">getRowsColumnRange</span></code>),
the range scan for J is potentially costly, as it needs to iterate through every todo for people whose names
do indeed begin with J.</p></li>
</ol>
<p>Notice, though, that all of the queries apart from 9 can be answered without a row range scan.</p>
</section>
<section id="using-dynamic-columns">
<h2>Using Dynamic Columns<a class="headerlink" href="#using-dynamic-columns" title="Permalink to this heading"></a></h2>
<section id="storage">
<h3>Storage<a class="headerlink" href="#storage" title="Permalink to this heading"></a></h3>
<p>One can use the standard <code class="docutils literal notranslate"><span class="pre">put</span></code> method. This can be used to add one or more columns to a row.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">TodoTable</span><span class="w"> </span><span class="n">todoTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TodoSchemaTableFactory</span><span class="p">.</span><span class="na">of</span><span class="p">().</span><span class="na">getTodoTable</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>

<span class="n">todoTable</span><span class="p">.</span><span class="na">put</span><span class="p">(</span>
<span class="w">        </span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoRow</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">person</span><span class="p">),</span>
<span class="w">        </span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoColumnValue</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoColumn</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">size1</span><span class="p">,</span><span class="w"> </span><span class="n">cost1</span><span class="p">),</span><span class="w"> </span><span class="n">description1</span><span class="p">),</span>
<span class="w">        </span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoColumnValue</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoColumn</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">size2</span><span class="p">,</span><span class="w"> </span><span class="n">cost2</span><span class="p">),</span><span class="w"> </span><span class="n">description2</span><span class="p">));</span>
</pre></div>
</div>
<p>Note that if the table already consists of a value for a given row key and dynamic column key, then this put
will logically overwrite the existing value.</p>
</section>
<section id="retrieval">
<h3>Retrieval<a class="headerlink" href="#retrieval" title="Permalink to this heading"></a></h3>
<p>Typically, one should use <code class="docutils literal notranslate"><span class="pre">getRowsColumnRange</span></code>. This takes a collection of rows and column key ranges, and returns a
map of row-keys to <code class="docutils literal notranslate"><span class="pre">BatchingVisitables</span></code> of column values. These may in turn be traversed using the
<code class="docutils literal notranslate"><span class="pre">BatchingVisitable</span></code> API. For example, the code below is an implementation of query 1 for an arbitrary String
<code class="docutils literal notranslate"><span class="pre">person</span></code>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">TodoTable</span><span class="w"> </span><span class="n">todoTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TodoSchemaTableFactory</span><span class="p">.</span><span class="na">of</span><span class="p">().</span><span class="na">getTodoTable</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoRow</span><span class="p">,</span><span class="w"> </span><span class="n">BatchingVisitable</span><span class="o">&lt;</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoColumnValue</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">todoTable</span><span class="p">.</span><span class="na">getRowsColumnRange</span><span class="p">(</span>
<span class="w">                </span><span class="n">ImmutableList</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoRow</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">person</span><span class="p">)),</span>
<span class="w">                </span><span class="n">BatchColumnRangeSelection</span><span class="p">.</span><span class="na">create</span><span class="p">(</span>
<span class="w">                        </span><span class="n">PtBytes</span><span class="p">.</span><span class="na">EMPTY_BYTE_ARRAY</span><span class="p">,</span><span class="w"> </span><span class="c1">// Empty byte arrays mean unbounded.</span>
<span class="w">                        </span><span class="n">PtBytes</span><span class="p">.</span><span class="na">EMPTY_BYTE_ARRAY</span><span class="p">,</span>
<span class="w">                        </span><span class="mi">1</span><span class="p">));</span><span class="w"> </span><span class="c1">// The batch hint is 1, because we are only interested in the first result.</span>

<span class="n">AtomicReference</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicReference</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">BatchingVisitable</span><span class="o">&lt;</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoColumnValue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">visitable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Iterables</span><span class="p">.</span><span class="na">getOnlyElement</span><span class="p">(</span><span class="n">results</span><span class="p">.</span><span class="na">values</span><span class="p">());</span>
<span class="n">visitable</span><span class="p">.</span><span class="na">batchAccept</span><span class="p">(</span>
<span class="w">        </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="c1">// We can consider batches of 1 element at a time, because we are only interested in the first element.</span>
<span class="w">        </span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">element</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">ImmutableTodo</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="na">getValue</span><span class="p">()));</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// Do not want any more, since we know our first batch contains the one.</span>
<span class="w">        </span><span class="p">});</span>
<span class="k">return</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>One can also use the <code class="docutils literal notranslate"><span class="pre">getRowsMultimap</span></code> method to retrieve a multimap of rows to column values. However, note
that this method will call the underlying transaction’s <code class="docutils literal notranslate"><span class="pre">getRows</span></code> method, which eagerly loads the entire row into
memory!</p>
</div>
</section>
</section>
<section id="data-representation-cassandra">
<h2>Data Representation (Cassandra)<a class="headerlink" href="#data-representation-cassandra" title="Permalink to this heading"></a></h2>
<p>A row with dynamic columns is stored as a single Cassandra-level row. Recall the Atlas schema:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span><span class="w"> </span><span class="n">TABLE</span><span class="w"> </span><span class="n">atlasete</span><span class="p">.</span><span class="na">default__todo</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">key</span><span class="w"> </span><span class="n">blob</span><span class="p">,</span>
<span class="w">    </span><span class="n">column1</span><span class="w"> </span><span class="n">blob</span><span class="p">,</span>
<span class="w">    </span><span class="n">column2</span><span class="w"> </span><span class="n">bigint</span><span class="p">,</span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="n">blob</span><span class="p">,</span>
<span class="w">    </span><span class="n">PRIMARY</span><span class="w"> </span><span class="nf">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">column1</span><span class="p">,</span><span class="w"> </span><span class="n">column2</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">key</span></code> consists of the (encoded) row key; <code class="docutils literal notranslate"><span class="pre">column1</span></code> refers to the (encoded) column components, and <code class="docutils literal notranslate"><span class="pre">column2</span></code>
refers to the Atlas timestamp at which a write occurred. The clustering order of the table follows the
<code class="docutils literal notranslate"><span class="pre">ValueByteOrder</span></code> of the relevant column components.</p>
<p>Conversely, observe that in a conventional (fixed columns) AtlasDB table, <code class="docutils literal notranslate"><span class="pre">column1</span></code> identifies which column is being
encoded in the <code class="docutils literal notranslate"><span class="pre">value</span></code>.</p>
</section>
<section id="when-not-to-use-dynamic-columns">
<h2>When Not To Use Dynamic Columns<a class="headerlink" href="#when-not-to-use-dynamic-columns" title="Permalink to this heading"></a></h2>
<p>Using (Atlas) dynamic columns creates wide rows in Cassandra, because every dynamic column key and value are stored
with the same row key. This may add limits to the scalability of the data, because all data for a single row key will
be stored on a single machine in the cluster.</p>
<p>Generally, we recommend that row sizes are kept in the tens of MBs at most, and also below one million dynamic column
keys.</p>
</section>
<section id="appendix-sample-query-implementations">
<h2>Appendix: Sample Query Implementations<a class="headerlink" href="#appendix-sample-query-implementations" title="Permalink to this heading"></a></h2>
<p>We present possible implementations of some of the queries (or generalisations of them) described above.
Note that an implementation of query 1 has been included in the “Retrieval” section.</p>
<section id="query-3-size-lower-to-upper-limit-n">
<h3>Query 3 (Size Lower to Upper, Limit N)<a class="headerlink" href="#query-3-size-lower-to-upper-limit-n" title="Permalink to this heading"></a></h3>
<p>Assume the existence of variables <code class="docutils literal notranslate"><span class="pre">lower</span></code> and <code class="docutils literal notranslate"><span class="pre">upper</span></code> (inclusive bounds for the size range; 10 and 15 in the
sample query), <code class="docutils literal notranslate"><span class="pre">person</span></code> (the person to run the query for) and <code class="docutils literal notranslate"><span class="pre">limit</span></code> (the maximum number of records we want to
return).</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">TodoTable</span><span class="w"> </span><span class="n">todoTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TodoSchemaTableFactory</span><span class="p">.</span><span class="na">of</span><span class="p">().</span><span class="na">getTodoTable</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>

<span class="c1">// Note that a column range selection is a start-inclusive end-exclusive range, so using (upper, Long.MAX_VALUE)</span>
<span class="c1">// as the end of the column selection is incorrect, because it excludes that specific dynamic column key.</span>
<span class="n">BatchColumnRangeSelection</span><span class="w"> </span><span class="n">selection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BatchColumnRangeSelection</span><span class="p">.</span><span class="na">create</span><span class="p">(</span>
<span class="w">        </span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoColumn</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">MIN_VALUE</span><span class="p">).</span><span class="na">persistToBytes</span><span class="p">(),</span>
<span class="w">        </span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoColumn</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">upper</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">MIN_VALUE</span><span class="p">).</span><span class="na">persistToBytes</span><span class="p">(),</span>
<span class="w">        </span><span class="n">limit</span><span class="p">)</span>

<span class="n">Map</span><span class="o">&lt;</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoRow</span><span class="p">,</span><span class="w"> </span><span class="n">BatchingVisitable</span><span class="o">&lt;</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoColumnValue</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">todoTable</span><span class="p">.</span><span class="na">getRowsColumnRange</span><span class="p">(</span><span class="n">ImmutableList</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoRow</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">person</span><span class="p">)),</span><span class="w"> </span><span class="n">selection</span><span class="p">);</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">();</span>
<span class="n">BatchingVisitable</span><span class="o">&lt;</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoColumnValue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">visitable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Iterables</span><span class="p">.</span><span class="na">getOnlyElement</span><span class="p">(</span><span class="n">results</span><span class="p">.</span><span class="na">values</span><span class="p">());</span>
<span class="n">visitable</span><span class="p">.</span><span class="na">batchAccept</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">item</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">columnValue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ImmutableTodo</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">columnValue</span><span class="p">.</span><span class="na">getValue</span><span class="p">())));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">limit</span><span class="p">;</span>
<span class="p">});</span>
<span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">subList</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">);</span><span class="w"> </span><span class="c1">// The batch hint may not always be respected exactly.</span>
</pre></div>
</div>
</section>
<section id="query-6-size-lowersize-to-uppersize-cost-lowercost-to-uppercost">
<h3>Query 6 (Size lowerSize to upperSize, Cost lowerCost to upperCost)<a class="headerlink" href="#query-6-size-lowersize-to-uppersize-cost-lowercost-to-uppercost" title="Permalink to this heading"></a></h3>
<p>Assume the existence of variables <code class="docutils literal notranslate"><span class="pre">lowerSize</span></code>, <code class="docutils literal notranslate"><span class="pre">upperSize</span></code>, <code class="docutils literal notranslate"><span class="pre">lowerCost</span></code> and <code class="docutils literal notranslate"><span class="pre">upperCost</span></code> which are inclusive bounds for the
size and cost ranges respectively. We also assume the existence of <code class="docutils literal notranslate"><span class="pre">person</span></code> (the person to run the query for).</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">TodoTable</span><span class="w"> </span><span class="n">todoTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TodoSchemaTableFactory</span><span class="p">.</span><span class="na">of</span><span class="p">().</span><span class="na">getTodoTable</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoRow</span><span class="p">,</span><span class="w"> </span><span class="n">BatchingVisitable</span><span class="o">&lt;</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoColumnValue</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">todoTable</span><span class="p">.</span><span class="na">getRowsColumnRange</span><span class="p">(</span>
<span class="w">                </span><span class="n">ImmutableList</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoRow</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">person</span><span class="p">)),</span>
<span class="w">                </span><span class="n">BatchColumnRangeSelection</span><span class="p">.</span><span class="na">create</span><span class="p">(</span>
<span class="w">                        </span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoColumn</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">lowerSize</span><span class="p">,</span><span class="w"> </span><span class="n">lowerCost</span><span class="p">).</span><span class="na">persistToBytes</span><span class="p">(),</span>
<span class="w">                        </span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoColumn</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">upperSize</span><span class="p">,</span><span class="w"> </span><span class="n">upperCost</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="na">persistToBytes</span><span class="p">(),</span><span class="w"> </span><span class="c1">// end is exclusive</span>
<span class="w">                        </span><span class="mi">100</span><span class="p">));</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">();</span>
<span class="n">BatchingVisitable</span><span class="o">&lt;</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoColumnValue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">visitable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Iterables</span><span class="p">.</span><span class="na">getOnlyElement</span><span class="p">(</span><span class="n">results</span><span class="p">.</span><span class="na">values</span><span class="p">());</span>
<span class="n">visitable</span><span class="p">.</span><span class="na">batchAccept</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">item</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">columnValue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// needed to ignore values with an intermediate size that are not in the cost range</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">columnValue</span><span class="p">.</span><span class="na">getColumnName</span><span class="p">().</span><span class="na">getMonetaryCost</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">lowerCost</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="n">columnValue</span><span class="p">.</span><span class="na">getColumnName</span><span class="p">().</span><span class="na">getMonetaryCost</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">upperCost</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ImmutableTodo</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">columnValue</span><span class="p">.</span><span class="na">getValue</span><span class="p">()));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="p">});</span>
<span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="query-8-smallest-for-multiple-row-keys">
<h3>Query 8 (Smallest for Multiple Row Keys)<a class="headerlink" href="#query-8-smallest-for-multiple-row-keys" title="Permalink to this heading"></a></h3>
<p>Assume the existence of a Set of Strings, <code class="docutils literal notranslate"><span class="pre">personSet</span></code>. This corresponds to person identifiers.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Maps</span><span class="p">.</span><span class="na">newConcurrentMap</span><span class="p">();</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">smallestSizes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Maps</span><span class="p">.</span><span class="na">newConcurrentMap</span><span class="p">();</span>
<span class="n">TodoTable</span><span class="w"> </span><span class="n">todoTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TodoSchemaTableFactory</span><span class="p">.</span><span class="na">of</span><span class="p">().</span><span class="na">getTodoTable</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoRow</span><span class="p">,</span><span class="w"> </span><span class="n">BatchingVisitable</span><span class="o">&lt;</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoColumnValue</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">visitables</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">todoTable</span><span class="p">.</span><span class="na">getRowsColumnRange</span><span class="p">(</span>
<span class="w">                </span><span class="n">personSet</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">TodoTable</span><span class="p">.</span><span class="na">TodoRow</span><span class="p">::</span><span class="n">of</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">()),</span>
<span class="w">                </span><span class="c1">// This MUST be unbounded because each person could have a different size of smallest task</span>
<span class="w">                </span><span class="n">BatchColumnRangeSelection</span><span class="p">.</span><span class="na">create</span><span class="p">(</span>
<span class="w">                        </span><span class="n">PtBytes</span><span class="p">.</span><span class="na">EMPTY_BYTE_ARRAY</span><span class="p">,</span>
<span class="w">                        </span><span class="n">PtBytes</span><span class="p">.</span><span class="na">EMPTY_BYTE_ARRAY</span><span class="p">,</span>
<span class="w">                        </span><span class="mi">100</span><span class="p">));</span><span class="w"> </span><span class="c1">// Magic number; it&#39;s hard to prescribe a one-size-fits-all value here.</span>

<span class="n">visitables</span><span class="p">.</span><span class="na">entrySet</span><span class="p">().</span><span class="na">forEach</span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">().</span><span class="na">getPerson</span><span class="p">();</span>
<span class="w">    </span><span class="n">results</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">person</span><span class="p">,</span><span class="w"> </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">());</span>
<span class="w">    </span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">batchAccept</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">columnValues</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">columnValues</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Triggers on the first batch.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">smallestSize</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">person</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// This suffices, even if the first batch has multiple task sizes, because dynamic columns are</span>
<span class="w">            </span><span class="c1">// returned in sorted order.</span>
<span class="w">            </span><span class="n">smallestSize</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">person</span><span class="p">,</span><span class="w"> </span><span class="n">columnValues</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="na">getColumnName</span><span class="p">().</span><span class="na">getTaskSize</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">smallestSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smallestSizes</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">person</span><span class="p">);</span>
<span class="w">        </span><span class="n">columnValues</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">columnValue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">columnValue</span><span class="p">.</span><span class="na">getColumnName</span><span class="p">().</span><span class="na">getTaskSize</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">smallestSize</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">columnValue</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">results</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">person</span><span class="p">).</span><span class="na">add</span><span class="p">(</span><span class="n">ImmutableTodo</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">columnValue</span><span class="p">.</span><span class="na">getValue</span><span class="p">())));</span>

<span class="w">        </span><span class="c1">// If the last entry doesn&#39;t have the smallest size, we must have covered all of the smallest todos</span>
<span class="w">        </span><span class="c1">// in this batch. This works, because dynamic columns are returned in sorted order.</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">columnValues</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">columnValues</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="na">getColumnName</span><span class="p">().</span><span class="na">getTaskSize</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">smallest</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>
<span class="k">return</span><span class="w"> </span><span class="n">results</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="best_practices.html" class="btn btn-neutral float-left" title="Cassandra Best Practices" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="streams.html" class="btn btn-neutral float-right" title="Streams" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Palantir Technologies.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>