<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Physical Cleanup &mdash; OSS AtlasDB develop documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/release-notes.css?v=b943762f" />
      <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=fd4cc2db" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=4191f987"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Schema Migrations" href="migrating_schemas.html" />
    <link rel="prev" title="Cleanup Tasks" href="cleanup_tasks.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            OSS AtlasDB
          </a>
              <div class="version">
                develop
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Schemas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="tables_and_indices.html">Tables and Indices</a></li>
<li class="toctree-l2"><a class="reference internal" href="best_practices.html">Cassandra Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="dynamic_columns.html">Dynamic Columns</a></li>
<li class="toctree-l2"><a class="reference internal" href="streams.html">Streams</a></li>
<li class="toctree-l2"><a class="reference internal" href="cleanup_tasks.html">Cleanup Tasks</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Physical Cleanup</a></li>
<li class="toctree-l2"><a class="reference internal" href="migrating_schemas.html">Schema Migrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="oracle_table_mapping.html">Oracle Table Mapping</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../transactions/index.html">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster_management/index.html">Cluster Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../miscellaneous/index.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes/index.html">Releases</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OSS AtlasDB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Schemas</a></li>
      <li class="breadcrumb-item active">Physical Cleanup</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/palantir/atlasdb/blob/develop/docs/source/schemas/physical_cleanup.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="physical-cleanup">
<h1>Physical Cleanup<a class="headerlink" href="#physical-cleanup" title="Permalink to this heading"></a></h1>
<p>When using a MVCC scheme, there will be old data that is no longer
needed. We need to keep it around for a while because long running
read-only transactions may be reading it, but we eventually need to
clean up this old data.</p>
<p>AtlasDB has a variety of options for maximal flexibility.</p>
<section id="sweeping">
<span id="physical-cleanup-sweep"></span><h2>Sweeping<a class="headerlink" href="#sweeping" title="Permalink to this heading"></a></h2>
<p>Please consult the <a class="reference internal" href="../cluster_management/sweep.html#sweep"><span class="std std-ref">Sweep documentation</span></a> for more details on sweep.</p>
<section id="sentinel-values">
<h3>Sentinel Values<a class="headerlink" href="#sentinel-values" title="Permalink to this heading"></a></h3>
<p>The primary objective of AtlasDB is correctness. This manifests by never
relying on time for correctness. This means that we can’t just assume
that a transaction that has been running for a day is aware that is
supposed to stop reading. It may continue reading and we want it to
throw rather than returning the wrong data. Returning data that
represents a state of the world that isn’t the snapshot it’s reading
would totally break the transactional guarantees we want.</p>
<p>We achieve this by writing an empty byte array at the <code class="docutils literal notranslate"><span class="pre">-1</span></code>
timestamp called the sentinel value. Then we delete any data we think
should be cleaned up. Now, if a transaction reads the sentinel value, it
knows that it is missing data that it should have read. We throw in this
case rather than allowing inconsistent reads.</p>
</section>
</section>
<section id="sweep-strategies">
<h2>Sweep Strategies<a class="headerlink" href="#sweep-strategies" title="Permalink to this heading"></a></h2>
<section id="sweepstrategy-nothing">
<h3>SweepStrategy.NOTHING<a class="headerlink" href="#sweepstrategy-nothing" title="Permalink to this heading"></a></h3>
<p>This disables sweeping for this table (including for manual sweep).</p>
</section>
<section id="sweepstrategy-conservative">
<h3>SweepStrategy.CONSERVATIVE<a class="headerlink" href="#sweepstrategy-conservative" title="Permalink to this heading"></a></h3>
<p>This is the default, but will always leave the most recent value and
also always keep a sentinel value (-1 timestamp). Even if the most
recent value is a delete, there will be 2 entries for each cell. (row,
col, -1, byte[0]) and also a delete entry at (row, col,
most_recent_ts, byte[0])</p>
</section>
<section id="sweepstrategy-thorough">
<h3>SweepStrategy.THOROUGH<a class="headerlink" href="#sweepstrategy-thorough" title="Permalink to this heading"></a></h3>
<p>This sweep mode will clean up sentinel values and also the most recent
value if it is a delete. This is great for space savings where you have
a <code class="docutils literal notranslate"><span class="pre">CELL_REFERENCING</span></code> index that has a lot of churn.</p>
<p>There are 2 main downsides to THOROUGH:</p>
<ol class="arabic simple">
<li><p>Read only transactions are not allowed to read THOROUGH tables. This
is because we clean the sentinel and a read only transaction may read
a cell as a delete when it should have read data and we can no longer
detect this case because we removed the sentinel.</p></li>
<li><p>Any readers of this table have to ensure their locks are still valid
at read time. This is to prevent the case where the sweeper moves
past your transaction because your immutable timestamp lock has
expired. If the sweeper moved past your transaction, it may have
cleaned up stuff you should have read.</p></li>
</ol>
</section>
</section>
<section id="scrubbing">
<h2>Scrubbing<a class="headerlink" href="#scrubbing" title="Permalink to this heading"></a></h2>
<p>If a transaction is marked as <code class="docutils literal notranslate"><span class="pre">TransactionType.HARD_DELETE</span></code> or
<code class="docutils literal notranslate"><span class="pre">TransactionType.AGGRESSIVE_HARD_DELETE</span></code> all the rows that have been
written are kept track of in the _scrub table. The scrubber will
inspect these rows and perform the same type of deletes as sweep, but
the data will be cleaned up much faster than a sweep which has to do a
big getRange over everything.</p>
<section id="aggressive-hard-delete">
<h3>AGGRESSIVE_HARD_DELETE<a class="headerlink" href="#aggressive-hard-delete" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">AGGRESSIVE_HARD_DELETE</span></code> will immediately call scrub after the
transaction is complete within the <code class="docutils literal notranslate"><span class="pre">TransactionManager.run*</span></code> call and
block until these rows are scrubbed. This must block until the
immutableTimestamp has passed the transaction, so it may take a second.
This will run all the OnCleanupTasks for the tables affected and block
again if those cause more rows to be cleaned.</p>
<p>Another side effect of AGGRESSIVE_HARD_DELETE is that read only
transactions may be aborted if they would read data that has been
aggressively scrubbed (even if they haven’t timed out yet).</p>
<p>So basically you want the data deleted NOW maybe due to legal issues and
you do this at the expense of having some read only transactions fail.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="cleanup_tasks.html" class="btn btn-neutral float-left" title="Cleanup Tasks" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="migrating_schemas.html" class="btn btn-neutral float-right" title="Schema Migrations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Palantir Technologies.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>