

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Streams &mdash; OSS AtlasDB develop documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=7ab3649f" />
      <link rel="stylesheet" type="text/css" href="../_static/release-notes.css?v=b943762f" />
      <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=fd4cc2db" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=4191f987"></script>
      <script src="../_static/doctools.js?v=888ff710"></script>
      <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Cleanup Tasks" href="cleanup_tasks.html" />
    <link rel="prev" title="Dynamic Columns" href="dynamic_columns.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            OSS AtlasDB
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Schemas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="tables_and_indices.html">Tables and Indices</a></li>
<li class="toctree-l2"><a class="reference internal" href="best_practices.html">Cassandra Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="dynamic_columns.html">Dynamic Columns</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Streams</a></li>
<li class="toctree-l2"><a class="reference internal" href="cleanup_tasks.html">Cleanup Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="physical_cleanup.html">Physical Cleanup</a></li>
<li class="toctree-l2"><a class="reference internal" href="migrating_schemas.html">Schema Migrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="oracle_table_mapping.html">Oracle Table Mapping</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../transactions/index.html">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster_management/index.html">Cluster Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../miscellaneous/index.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes/index.html">Releases</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OSS AtlasDB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Schemas</a></li>
      <li class="breadcrumb-item active">Streams</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/palantir/atlasdb/blob/develop/docs/source/schemas/streams.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="streams">
<span id="schemas-streams"></span><h1>Streams<a class="headerlink" href="#streams" title="Permalink to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h2>
<p>When storing large objects in an AtlasDB database, the underlying
database can impose limits on the size of the object and its performance
characteristics. Postgres has a 1GB entry limit, and Cassandra generally
does not like transmissions of over 30MB over the wire at a time.</p>
<p>If it is known beforehand that a particular column of a table will store
large objects, the objects should instead be stored in a stream store table.
AtlasDB will automatically segment large objects in a stream store into
smaller chunks, and storage of streams happens on separate transactions and
does not count toward your byte limit for your local trasaction.</p>
<p>The minimal parameters required to define a stream store are shown below:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addStreamStoreDefinition</span><span class="p">(</span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">StreamStoreDefinitionBuilder</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">shortName</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">longName</span><span class="p">,</span><span class="w"> </span><span class="n">ValueType</span><span class="w"> </span><span class="n">valueType</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
<span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">shortName</span></code> is the prefix which will be used in the actual database tables.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">longName</span></code> is the name of the stream store in the generated Java code.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">valueType</span></code> specifies the value type of the id for each stored object.</p></li>
</ul>
<p>Additional options for the builder include:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 80.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Option</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">hashRowComponents</span></code></p></td>
<td><p>Hashes the concatenation of the <code class="docutils literal notranslate"><span class="pre">id</span></code> and <code class="docutils literal notranslate"><span class="pre">blockId</span></code> components of the table storing the data blocks and prepends it to the row key. If using Cassandra KVS, we recommend that this flag is set in order to prevent hotspotting. We do not support adding this to an existing StreamStore, as it would require data migration.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">hashFirstRowComponent</span></code></p></td>
<td><p>Hashes the <code class="docutils literal notranslate"><span class="pre">id</span></code> component of the table.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">isAppendHeavyAndReadLight</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">false</span></code> by default. If set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, some optimisations will be made in Cassandra KVS assuming that these streams will be changed often but not read often.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">compressStreamInClient</span></code></p></td>
<td><p>Transparently decompresses and compresses the stream via the LZ4 algorithm upon reads and writes, respectively. Compression is performed client side before any network communication to the underlying database.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">inMemoryThreshold</span></code></p></td>
<td><p>Specifies the largest size object (in bytes) which AtlasDB will cache in memory in order to boost retrieval performance.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">tableNameLogSafety</span></code></p></td>
<td><p>Specifies the if the table name is safe to added to logs and metrics. By default, the table is considered <code class="docutils literal notranslate"><span class="pre">UNSAFE</span></code>.</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If using Cassandra KVS, we <em>strongly</em> recommend that <code class="docutils literal notranslate"><span class="pre">hashRowComponents()</span></code> is set, in order to avoid hotspotting.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We <em>strongly</em> recommend using <code class="docutils literal notranslate"><span class="pre">tableNameLogSafety(TableMetadataPersistence.LogSafety.SAFE)</span></code> if the table has a safe name.</p>
</div>
<p>For an example of streams in use, see the <code class="docutils literal notranslate"><span class="pre">user_profile</span></code> table and <code class="docutils literal notranslate"><span class="pre">user_photos</span></code> stream store in <a class="reference external" href="https://github.com/palantir/atlasdb/blob/cd4f33dfcaa95acb90374f698158a4aae8c28945/examples/profile-client/src/main/java/com/palantir/example/profile/schema/ProfileSchema.java">ProfileSchema</a>, and the <code class="docutils literal notranslate"><span class="pre">updateImage</span></code> method in <a class="reference external" href="https://github.com/palantir/atlasdb/blob/cd4f33dfcaa95acb90374f698158a4aae8c28945/examples/profile-client/src/main/java/com/palantir/example/profile/ProfileStore.java#L92-L110">ProfileStore</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In some places, we load whole numbers of blocks into memory, so if the in-memory threshold is smaller than the block size (1MB), we will still load a whole block.</p>
</div>
</section>
<section id="storing-streams">
<h2>Storing Streams<a class="headerlink" href="#storing-streams" title="Permalink to this heading"></a></h2>
<p>Users have two options to store streams.</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">getByHashOrStoreStreamAndMarkAsUsed(Transaction</span> <span class="pre">t,</span> <span class="pre">Sha256Hash</span> <span class="pre">hash,</span> <span class="pre">InputStream</span> <span class="pre">stream,</span> <span class="pre">byte[]</span> <span class="pre">reference)</span></code> is called <em>within</em> a transaction. It will store the stream and mark it as used by <code class="docutils literal notranslate"><span class="pre">reference</span></code>. This method is the preferred method to store small (&lt;100 MB) streams.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">storeStream(InputStream</span> <span class="pre">stream)</span></code> is called <em>outside</em> a transaction. It will store a stream without marking it as used, and users should mark the stream as used via <code class="docutils literal notranslate"><span class="pre">markStreamAsUsed(Transaction</span> <span class="pre">t,</span> <span class="pre">long</span> <span class="pre">streamId,</span> <span class="pre">byte[]</span> <span class="pre">reference)</span></code> immediately after. Users of this method need to retry if their stream was cleaned up between storing and marking. This method is the preferred method for very large streams (&gt;100 MB) that would otherwise cause the transaction within which the stream is being stored to be too long running.</p></li>
</ol>
<p>Regular AtlasDB tables should refer to the object stored in stream stores by their <code class="docutils literal notranslate"><span class="pre">streamId</span></code>, and the <code class="docutils literal notranslate"><span class="pre">reference</span></code> that users mark the stream with should correspond to a value computable based on the parameters of the cell the <code class="docutils literal notranslate"><span class="pre">streamId</span></code> is stored in. If the <code class="docutils literal notranslate"><span class="pre">streamId</span></code> is deleted from a cell, users need to mark the stream as unused by the reference corresponding to that cell to enable garbage collection.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>References to streams are <em>manually</em> added (via either <code class="docutils literal notranslate"><span class="pre">getByHashOrStoreStreamAndMarkAsUsed</span></code> or <code class="docutils literal notranslate"><span class="pre">markStreamAsUsed</span></code>) and removed (via the method <code class="docutils literal notranslate"><span class="pre">markStreamAsUnused</span></code>) by users. AtlasDB monitors the number of references to each stream, and streams that are unreferenced will be garbage collected.</p>
</div>
</section>
<section id="performance">
<h2>Performance<a class="headerlink" href="#performance" title="Permalink to this heading"></a></h2>
<p>Streams are marked as <code class="docutils literal notranslate"><span class="pre">cachePriority(CachePriority.COLD)</span></code> by default.
This is a hint to the key value store that these can potentially be
stored on different media than regular tables. One simple way to handle
this is to write a <code class="docutils literal notranslate"><span class="pre">KeyValueService</span></code> implementation that just
delegates to 2 other <code class="docutils literal notranslate"><span class="pre">KeyValueService</span></code> impls and sends COLD tables to
one and other tables to another.</p>
<p>Streams can be optionally compressed to boost performance via the
<code class="docutils literal notranslate"><span class="pre">compressStreamsInClient</span></code> option on the <code class="docutils literal notranslate"><span class="pre">StreamStoreDefinitionBuilder</span></code>.</p>
</section>
<section id="transactionality">
<h2>Transactionality<a class="headerlink" href="#transactionality" title="Permalink to this heading"></a></h2>
<p>When you call <code class="docutils literal notranslate"><span class="pre">loadStream(transaction,</span> <span class="pre">id)</span></code>, only the first section of the stream data is pre-loaded as part of that transaction.
The amount loaded is determined by the block size (1MB) and the in-memory threshold (4MiB by default); we load at least one block,
a whole number of blocks, and (if the in-memory threshold is at least the block size) as many blocks as fit inside the in-memory threshold.
So by default, we load 4 blocks (<code class="docutils literal notranslate"><span class="pre">4*10^6</span></code> bytes, slightly less than the default in-memory threshold of <code class="docutils literal notranslate"><span class="pre">4*2^20</span></code> bytes).
If your stream does not fit inside the in-memory threshold, then the remainder of the data will be buffered in separate transactions.</p>
<p>This has some subtle transactionality implications.
Suppose you store a mapping of keys to stream IDs, and at <code class="docutils literal notranslate"><span class="pre">start_timestamp</span></code>, <code class="docutils literal notranslate"><span class="pre">key</span></code> maps to <code class="docutils literal notranslate"><span class="pre">stream_id_1</span></code>.
You then call <code class="docutils literal notranslate"><span class="pre">loadStream(transaction,stream_id_1)</span></code>, and keep the resulting <code class="docutils literal notranslate"><span class="pre">InputStream</span></code> open.
Before you reach the end of the stream, another thread stores a mapping from <code class="docutils literal notranslate"><span class="pre">key</span></code> to <code class="docutils literal notranslate"><span class="pre">stream_id_2</span></code>.
In this case, streaming of the original stream will continue and complete successfully, even though the data being streamed is out of date.</p>
<p>If you wish to guard against this case, you should kick off another read transaction after closing the stream, to verify that <code class="docutils literal notranslate"><span class="pre">key</span></code> still maps to <code class="docutils literal notranslate"><span class="pre">stream_id_1</span></code>.</p>
</section>
<section id="non-duplication">
<h2>Non-Duplication<a class="headerlink" href="#non-duplication" title="Permalink to this heading"></a></h2>
<p>A single stream of bytes may be stored multiple times and have many
references to it, but will only be stored once under the covers. When
all references to a stream are removed it will be cleaned up by the
OnCleanupTask that is registered with the cleaner. See
<a class="reference internal" href="cleanup_tasks.html#cleanup-tasks"><span class="std std-ref">Cleanup Tasks</span></a> for more details.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="dynamic_columns.html" class="btn btn-neutral float-left" title="Dynamic Columns" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="cleanup_tasks.html" class="btn btn-neutral float-right" title="Cleanup Tasks" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Palantir Technologies.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>